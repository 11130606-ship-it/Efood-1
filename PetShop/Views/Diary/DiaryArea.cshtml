@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var entries = ViewBag.UserDiaries as List<PetShop.Models.DiaryEntry>;
    var selectedDate = ViewBag.SelectedDate as string;
    var foodList = ViewBag.FoodList as List<PetShop.Models.Food>;
    var commonFoods = ViewBag.CommonFoods as List<PetShop.Models.CommonFood>;
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    #MyCanvas {
        flex: 1; /* 和左邊同寬，或你可用固定寬度 */
        max-width: 600px;
        min-height: 400px;
        background: #fffef8;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .page-wrapper {
        display: flex;
        gap: 20px; /* 左右間距 */
        align-items: flex-start; /* 頂端對齊 */
        padding: 20px;
        box-sizing: border-box;
        height: 80vh; /* 視需要調整高度 */
    }

    .container {
        flex: 1; /* 撐滿剩餘空間 */
        max-width: 600px; /* 限制最大寬度，避免太寬 */
        overflow-y: auto; /* 內容超長可滾動 */
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
</style>
<div class="page-wrapper">
    <div class="container mt-5">
        <h2 class="mb-4">📔 飲食日記</h2>

        <!-- 成功/失敗訊息 -->
        @if (TempData["Msg"] != null)
        {
            <div class="alert alert-info">@TempData["Msg"]</div>
        }

        <!-- 日記輸入表單 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <form method="post" action="/Home/DiaryArea">
                    <div class="form-group">
                        <label for="diaryContent">請輸入今日的飲食紀錄：</label>
                        <br />
                        <textarea class="form-control" id="diaryContent" name="A" rows="3" placeholder="例如：早餐吃了雞蛋和燕麥…"></textarea>
                    </div>
                    <select id="foodSelect" name="FoodCalories" onchange="showCalories()">
                        <option value="">-- 請選擇食材 --</option>
                        @if (foodList != null)
                        {
                            foreach (var food in foodList)
                            {
                                <option value="@food.熱量_kcal"
                                        data-protein="@food.蛋白質_g"
                                        data-fat="@food.脂肪_g"
                                        data-carb="@food.碳水化合物_g">
                                    @food.食品名稱 (@food.熱量_kcal kcal)
                                </option>
                            }
                        }
                    </select>
                    <select id="commonSelect" name="CommonCalories" onchange="showCalories()">
                        <option value="">-- 請選擇食物 --</option>
                        @if (commonFoods != null)
                        {
                            foreach (var common in commonFoods)
                            {
                                <option value="@common.Calories"
                                        data-protein="@common.Protein"
                                        data-fat="@common.Fat"
                                        data-carb="@common.Carbs">
                                    @common.Name (@common.Calories kcal)
                                </option>
                            }
                        }
                    </select>
                    <input type="hidden" id="foodName" name="FoodName" />
                    <button type="submit" class="btn btn-primary mt-2">➕ 儲存日記</button>
                </form>
            </div>
        </div>
        <br />
        <!-- 歷史日記顯示 -->
        <form method="get" action="/Home/DiaryIndex" class="mb-3">
            <label for="searchDate">🔍 選擇日期查看紀錄：</label>
            <input type="date" id="searchDate" name="date" class="form-control"
                   value="@Request.QueryString["date"]" onchange="this.form.submit()" />
        </form>

        <h4 class="mb-3">
            🕒
            @if (!string.IsNullOrEmpty(selectedDate))
            {
                <text>@selectedDate 的日記紀錄：</text>
            }
            else
            {
                <text>所有日記紀錄：</text>
            }
        </h4>

        @if (entries != null && entries.Count > 0)
        {
            <ul class="list-group">
                @foreach (var entry in entries)
                {
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">@entry.CreateTime.ToString("yyyy-MM-dd HH:mm")</span>
                            <span class="badge badge-secondary">日記</span>
                        </div>
                        <div class="mt-2">
                            @if (!string.IsNullOrWhiteSpace(entry.Content))
                            {
                                <div><strong>內容：</strong>@entry.Content</div>
                            }
                            @if (!string.IsNullOrWhiteSpace(entry.Food))
                            {
                                <div><strong>食物：</strong>@entry.Food</div>
                                <div><strong>熱量：</strong>@entry.Calories kcal</div>
                            }
                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <div class="alert alert-secondary">尚無日記紀錄。</div>
        }
    </div>
    <canvas id="MyCanvas"></canvas>
</div>
<script>
    var ctx = document.getElementById("MyCanvas").getContext("2d");
    var MyData = {
        type: "bar",
        data: {
            labels: ["熱量", "蛋白質", "脂肪", "碳水化合物"],
            datasets: [{
                label: "營養成分",
                data: [],
                backgroundColor: [
                    "rgba(75,192,192,0.6)",
                    "rgba(255,99,132,0.6)",
                    "rgba(255,206,86,0.6)",
                    "rgba(54,162,235,0.6)"
                ]
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    };
    var MyChart = new Chart(ctx, MyData);

    function showCalories() {
        let select = document.getElementById("foodSelect");
        let value = select.value;
        let text = select.options[select.selectedIndex].text;
        let protein = select.options[select.selectedIndex].getAttribute("data-protein");
        let fat = select.options[select.selectedIndex].getAttribute("data-fat");
        let carb = select.options[select.selectedIndex].getAttribute("data-carb");

        if (value) {
            // 更新圖表
            MyChart.data.labels = ["熱量", "蛋白質", "脂肪", "碳水化合物"];
            MyChart.data.datasets[0].data = [value, protein, fat, carb];
            MyChart.update();

            // 把食物名稱存進隱藏欄位
            document.getElementById("foodName").value = text;
        } else {
            document.getElementById("foodName").value = "";
        }
    }

</script>
