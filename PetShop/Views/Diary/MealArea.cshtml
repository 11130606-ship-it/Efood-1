@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var meals = ViewBag.Meals as List<PetShop.Models.MealChoiceEntry> ?? new List<PetShop.Models.MealChoiceEntry>();
    var selectedDate = ViewBag.SelectedDate as string;
    var mealOptions = ViewBag.MealOptions as Dictionary<string, List<string>> ?? new Dictionary<string, List<string>>();
}

<h2>餐點選擇</h2>

<label>選擇日期：</label>
<input type="date" id="mealDate" value="@selectedDate" />

<hr />

<form id="mealForm">
    <label>早餐:</label>
    <select id="breakfast">
        <option value="">請選擇早餐</option>
        @if (mealOptions.ContainsKey("早餐推薦"))
        {
            foreach (var opt in mealOptions["早餐推薦"])
            {
                <option>@opt</option>
            }
        }
    </select>
    <input type="text" id="breakfastCustom" placeholder="自行輸入早餐" />
    <br /><br />

    <label>午餐:</label>
    <select id="lunch">
        <option value="">請選擇午餐</option>
        @if (mealOptions.ContainsKey("午餐推薦"))
        {
            foreach (var opt in mealOptions["午餐推薦"])
            {
                <option>@opt</option>
            }
        }
    </select>
    <input type="text" id="lunchCustom" placeholder="自行輸入午餐" />
    <br /><br />

    <label>晚餐:</label>
    <select id="dinner">
        <option value="">請選擇晚餐</option>
        @if (mealOptions.ContainsKey("晚餐推薦"))
        {
            foreach (var opt in mealOptions["晚餐推薦"])
            {
                <option>@opt</option>
            }
        }
    </select>
    <input type="text" id="dinnerCustom" placeholder="自行輸入晚餐" />
    <br /><br />

    <button type="button" id="saveMeals">儲存餐點</button>
</form>

<h3>已選餐點 (@selectedDate)</h3>
<ul id="chosenMeals">
    @{
        var order = new[] { "早餐", "午餐", "晚餐" };
        foreach (var mealType in order)
        {
            var m = meals.FirstOrDefault(x => x.MealType == mealType);
            if (m != null)
            {
                <li id="meal_@m.MealType">@m.MealType: @m.Choice (@m.ChoiceDate.ToString("yyyy-MM-dd"))</li>
            }
            else
            {
                <li id="meal_@mealType">@mealType: </li>
            }
        }
    }
</ul>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function(){
        function saveMeal(mealType, selectId, inputId){
            let choice = $(inputId).val().trim() || $(selectId).val();
            if(!choice) return;

            $.post('/Home/SaveMealChoice', {
                mealType: mealType,
                selectedOption: choice,
                date: $('#mealDate').val()
            }, function(res){
                if(res.success){
                    var liId = '#meal_' + mealType;
                    if($(liId).length > 0){
                        $(liId).text(mealType + ": " + choice + " (" + $('#mealDate').val() + ")");
                    }else{
                        $('#chosenMeals').append('<li id="meal_' + mealType + '">' + mealType + ": " + choice + " (" + $('#mealDate').val() + ")</li>");
                    }
                } else {
                    alert("儲存失敗: " + res.message);
                }
            });
        }

        $('#saveMeals').click(function(){
            saveMeal('早餐', '#breakfast', '#breakfastCustom');
            saveMeal('午餐', '#lunch', '#lunchCustom');
            saveMeal('晚餐', '#dinner', '#dinnerCustom');
        });

        // 日期切換
        $('#mealDate').change(function(){
            var newDate = $(this).val();
            if(newDate){
                window.location.href = '/Home/MealIndex?date=' + newDate;
            }
        });

        // 預設載入已存的選擇
        @foreach(var m in meals){
            <text>
            $('#@m.MealType.ToLower()').val('@m.Choice');
            $('#@m.MealType.ToLower()Custom').val('@m.Choice');
            </text>
        }

        // 選單選了值就清空輸入框
        $('#breakfast').change(function(){ if($(this).val()) $('#breakfastCustom').val(''); });
        $('#lunch').change(function(){ if($(this).val()) $('#lunchCustom').val(''); });
        $('#dinner').change(function(){ if($(this).val()) $('#dinnerCustom').val(''); });

        // 輸入框打字就清空選單
        $('#breakfastCustom').on('input', function(){ if($(this).val()) $('#breakfast').val(''); });
        $('#lunchCustom').on('input', function(){ if($(this).val()) $('#lunch').val(''); });
        $('#dinnerCustom').on('input', function(){ if($(this).val()) $('#dinner').val(''); });
    });
</script>
<button onclick="saveMeal()">輸出我的全部餐點紀錄</button>

<script>
    function saveMeal() {
        $.getJSON('/Home/GetAllMealRecords', function (res) {
            if (res.success) {
                if (res.data.length === 0) {
                    alert("目前沒有任何紀錄");
                    return;
                }
                // 匯出 Excel
                alasql('SELECT * INTO XLSX("我的餐點紀錄.xlsx",{headers:true}) FROM ?', [res.data]);
            } else {
                alert("讀取失敗: " + res.message);
            }
        });
    }
</script>


<script src="https://cdn.jsdelivr.net/alasql/0.3/alasql.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.7.12/xlsx.core.min.js"></script>
